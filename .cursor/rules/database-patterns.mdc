---
description: "Database schema and migration patterns"
globs: packages/db/**/*.ts
---

# Database Development Guidelines

## Schema Definition Patterns
- Use Drizzle ORM with PostgreSQL
- Define tables using `pgTable` in [packages/db/src/schema/](mdc:packages/db/src/schema/)
- Follow consistent column patterns:
  - `id: t.uuid().notNull().primaryKey().defaultRandom()` for primary keys
  - `createdAt: t.timestamp().notNull().defaultNow()` for creation timestamps
  - `updatedAt: t.timestamp({ mode: "date", withTimezone: true }).$onUpdateFn(() => new Date())` for update timestamps

## Zod Schema Generation
Always generate Zod schemas from Drizzle schemas using `drizzle-zod`:
```typescript
import { createInsertSchema, createSelectSchema, createUpdateSchema } from "drizzle-zod";

export const courseInsertSchema = createInsertSchema(course);
export const courseSelectSchema = createSelectSchema(course);
export const courseUpdateSchema = createUpdateSchema(course);
```

## Foreign Key Patterns
- Use proper foreign key references: `.references(() => parentTable.id)`
- Include proper types for foreign keys matching the referenced column
- Consider cascade behaviors for deletions

Example from [packages/db/src/schema/course.ts](mdc:packages/db/src/schema/course.ts):
```typescript
instructorId: t
  .text()
  .notNull()
  .references(() => user.id),
```

## Relations Definition
- Define relations in separate files under `schema/relations/`
- Use Drizzle relations API for proper joins
- Export relation schemas for use in queries

## Migration Guidelines
- Use `pnpm db:generate` to create migrations
- Review generated SQL before applying
- Test migrations in development environment
- Keep migration files in version control

## Type Safety
- Export TypeScript types using Drizzle's inferred types
- Use `z.infer<typeof schema>` for Zod schema types
- Ensure consistent typing across database, API, and frontend layers